# returns interesting gadgets

import argparse

from ropgadget.core import Core  # pip3 install ropgadget
import ropgadget.args
from address_pop import null_free


class ROPgadgets(object):

    def __init__(self, binary):
        arguments = ["--binary", binary, "--silent", "--multibr"]
        args = ropgadget.args.Args(arguments).getArgs()
        core = Core(args)
        core.analyze()
        self.gadgets = core.gadgets()

    def get_gadgets(self):
        for gadget in self.gadgets:
            print(gadget['gadget'])

    def get_gadget(self, instruction):
        for gadget in self.gadgets:
            if gadget['gadget'] == instruction and null_free(gadget['vaddr']):
                return gadget['vaddr']
        return 0


def test():
    rop = ROPgadgets("vuln3-32-test")
    # rop.get_gadgets()
    assert (134672011 == rop.get_gadget("pop edx ; ret"))

if __name__ == '__main__':
    test()
